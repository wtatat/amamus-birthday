<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>В ЧЕСТЬ ВЕЛИКОГО AMAMUS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        #click-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #aae5a4; display: flex; justify-content: center;
            align-items: center; z-index: 20000; cursor: pointer;
        }
        #click-text {
            font-family: "Verdana", sans-serif; font-size: 3em; font-weight: bold;
            color: #000099; text-transform: uppercase; letter-spacing: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(1); }
        }
        body {
            margin: 0; padding: 0; background-color: #aae5a4; color: #000;
            font-family: "Verdana", sans-serif; text-align: center;
            overflow-x: hidden; cursor: crosshair;
        }
        .header-bar {
            background-color: #aae5a4; height: 60px; width: 100%;
            position: fixed; top: 0; left: 0; z-index: 10000;
            display: flex; align-items: center; padding-left: 20px;
            border-bottom: 1px solid #7cb576;
        }
        .header-logo { color: #000099; font-weight: bold; font-size: 2em; text-decoration: none; }
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .manul { position: absolute; pointer-events: none; opacity: 0.6; user-select: none; }
        .manul-bg { animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translateY(-150px) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(360deg); }
        }
        .section {
            min-height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 80px 20px 40px 20px;
            position: relative; z-index: 10; border-bottom: 1px solid #7cb576;
        }
        .main-photo { width: 400px; border: 3px solid #000099; margin: 20px 0; background-color: #fff; }
        h1 { font-size: 3.5em; color: #000099; }
        .comments-container { width: 100%; max-width: 800px; text-align: left; background-color: #aae5a4; }
        .comment-item { padding: 10px; border-bottom: 1px solid #7cb576; margin-bottom: 10px; font-size: 0.9em; }
        .comment-header { color: #000099; font-weight: bold; }
        .comment-body { margin-top: 8px; font-size: 1.1em; }
        
        .add-comment-form {
            width: 100%; max-width: 800px; margin-top: 30px; text-align: left;
            padding: 15px; border: 1px solid #7cb576; background: rgba(255,255,255,0.1);
        }
        .add-comment-form input, .add-comment-form textarea {
            width: 100%; box-sizing: border-box; border: 1px solid #7cb576;
            padding: 10px; font-family: Verdana; margin-bottom: 10px;
        }
        .add-comment-form button {
            background-color: #eee; border: 1px solid #7cb576; padding: 5px 15px;
            cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="click-overlay" onclick="startSite()">
        <div id="click-text">КЛИК</div>
    </div>

    <audio id="bgMusic" loop>
        <source src="72. Heahea City (Night).mp3" type="audio/mpeg">
    </audio>

    <div class="header-bar">
        <div class="header-logo">AMAMUS 34</div>
    </div>

    <div id="snow-container"></div>

    <div class="section">
        <img src="AMAMUS.jpg" alt="AMAMUS" class="main-photo">
        <h2 style="font-size: 2.5em;">Помним, любим, скорбим</h2>
    </div>

    <div class="section">
        <h2 style="color: #000099; font-size: 2.5em;">ЗАСЛУГИ (<span id="comment-count">0</span>)</h2>
        <div class="comments-container" id="comment-list">
            </div>

        <div class="add-comment-form">
            <div style="color: #000099; font-weight: bold; margin-bottom: 5px;">Ваш ник:</div>
            <input type="text" id="nickname-input" placeholder="Введите ник...">
            
            <div style="color: #000099; font-weight: bold; margin-bottom: 5px;">Текст заслуги:</div>
            <textarea id="comment-input" placeholder="Напишите что-нибудь..."></textarea><br>
            <button onclick="addComment()">Post comment</button>
        </div>
    </div>

    <script>
        // === НАСТРОЙКИ SUPABASE ===
        const SB_URL = 'https://wiqptoiikgjvjtwzpxjd.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpcXB0b2lpa2dqdmp0d3pweGpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDE4MzIsImV4cCI6MjA4MzAxNzgzMn0.OeNZKRx-FZN6Mjw9-kuPYy2HEA6Xkb-Sf6xRlscTMUc';
        const supabase = supabase.createClient(SB_URL, SB_KEY);

        const audio = document.getElementById('bgMusic');

        // 1. Загрузка ника из памяти браузера
        window.onload = () => {
            const savedNick = localStorage.getItem('user_nickname');
            if (savedNick) {
                document.getElementById('nickname-input').value = savedNick;
            }
        };

        async function loadComments() {
            const { data, error } = await supabase
                .from('comments')
                .select('*')
                .order('created_at', { ascending: true });

            if (data) {
                const list = document.getElementById('comment-list');
                list.innerHTML = '';
                data.forEach(c => {
                    renderComment(c.author_name, c.content, c.random_id, c.created_at);
                });
                document.getElementById('comment-count').innerText = data.length;
            }
        }

        function renderComment(name, text, rid, date) {
            const list = document.getElementById('comment-list');
            const div = document.createElement('div');
            div.className = 'comment-item';
            const formattedDate = new Date(date).toLocaleString();
            div.innerHTML = `
                <div class="comment-header">${name} <span style="color: #777; font-weight: normal;"> >> #${rid}</span></div>
                <div class="comment-meta">Posted on ${formattedDate}</div>
                <div class="comment-body">${text}</div>
            `;
            list.appendChild(div);
        }

        async function addComment() {
            const nickInput = document.getElementById('nickname-input');
            const textInput = document.getElementById('comment-input');
            const nick = nickInput.value.trim() || "Anonymous";
            const text = textInput.value.trim();

            if (!text) return;

            // Сохраняем ник в браузере навсегда
            localStorage.setItem('user_nickname', nick);

            const randomID = Math.floor(Math.random() * 99999999);

            const { error } = await supabase
                .from('comments')
                .insert([{ 
                    author_name: nick, 
                    content: text, 
                    random_id: randomID.toString() 
                }]);

            if (!error) {
                textInput.value = '';
                loadComments(); // Перезагружаем список
            }
        }

        function startSite() {
            document.getElementById('click-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            window.scrollTo(0, 0);
            
            audio.volume = 0;
            audio.play();
            let fadeInterval = setInterval(() => {
                if (audio.volume < 0.95) audio.volume += 0.05;
                else { audio.volume = 1; clearInterval(fadeInterval); }
            }, 200);

            loadComments();
        }

        // Манулы
        for (let i = 0; i < 20; i++) {
            const m = document.createElement('img');
            m.src = 'manul.jpg';
            m.className = 'manul manul-bg';
            m.style.width = (Math.random() * 60 + 40) + 'px';
            m.style.left = Math.random() * 100 + 'vw';
            m.style.animationDuration = (Math.random() * 5 + 4) + 's';
            m.style.animationDelay = Math.random() * 5 + 's';
            document.getElementById('snow-container').appendChild(m);
        }
    </script>
</body>
</html>
